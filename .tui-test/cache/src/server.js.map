{"version":3,"sources":["/Users/rquast/projects/fspec.videos/src/server.ts"],"sourcesContent":["import express, { Express } from 'express';\nimport { Server } from 'http';\nimport { AddressInfo } from 'net';\n\nexport interface ServerInfo {\n  url: string;\n  cleanup: () => Promise<void>;\n}\n\nexport async function startServer(): Promise<ServerInfo> {\n  const app: Express = express();\n\n  // Serve the terminal HTML page\n  app.get('/', (_req, res) => {\n    res.send(getTerminalHTML());\n  });\n\n  // Start the server\n  const server: Server = await new Promise((resolve, reject) => {\n    const s = app.listen(0, () => resolve(s));\n    s.on('error', reject);\n  });\n\n  const address = server.address() as AddressInfo;\n  const url = `http://localhost:${address.port}`;\n\n  const cleanup = async () => {\n    await new Promise<void>((resolve, reject) => {\n      server.close(err => {\n        if (err) reject(err);\n        else resolve();\n      });\n    });\n  };\n\n  return { url, cleanup };\n}\n\nfunction getTerminalHTML(): string {\n  return `\n<!DOCTYPE html>\n<html lang=\"en\">\n<head>\n  <meta charset=\"UTF-8\">\n  <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\n  <title>fspec Terminal Recording</title>\n  <link rel=\"stylesheet\" href=\"https://cdn.jsdelivr.net/npm/@xterm/xterm@5.5.0/css/xterm.css\" />\n  <style>\n    * {\n      margin: 0;\n      padding: 0;\n      box-sizing: border-box;\n    }\n    html, body {\n      width: 100%;\n      height: 100%;\n      background-color: #1e1e1e;\n      overflow: hidden;\n      font-family: 'Courier New', monospace;\n    }\n    #terminal-container {\n      width: 100%;\n      height: 100%;\n      background-color: #1e1e1e;\n    }\n    #terminal {\n      width: 100%;\n      height: 100%;\n    }\n    .xterm {\n      width: 100% !important;\n      height: 100% !important;\n    }\n    .xterm-screen {\n      width: 100% !important;\n      height: 100% !important;\n    }\n  </style>\n</head>\n<body>\n  <div id=\"terminal-container\">\n    <div id=\"terminal\"></div>\n  </div>\n\n  <script src=\"https://cdn.jsdelivr.net/npm/@xterm/xterm@5.5.0/lib/xterm.js\"></script>\n  <script src=\"https://cdn.jsdelivr.net/npm/@xterm/addon-canvas@0.7.0/lib/addon-canvas.js\"></script>\n  <script>\n    // Initialize xterm.js\n    const term = new Terminal({\n      cols: 120,\n      rows: 30,\n      fontSize: 96,\n      fontFamily: '\"Cascadia Code\", \"Fira Code\", \"Courier New\", monospace',\n      convertEol: true,\n      theme: {\n        background: '#1e1e1e',\n        foreground: '#d4d4d4',\n        cursor: '#ffffff',\n        cursorAccent: '#1e1e1e',\n        selection: 'rgba(255, 255, 255, 0.3)',\n        black: '#000000',\n        red: '#cd3131',\n        green: '#0dbc79',\n        yellow: '#e5e510',\n        blue: '#2472c8',\n        magenta: '#bc3fbc',\n        cyan: '#11a8cd',\n        white: '#e5e5e5',\n        brightBlack: '#666666',\n        brightRed: '#f14c4c',\n        brightGreen: '#23d18b',\n        brightYellow: '#f5f543',\n        brightBlue: '#3b8eea',\n        brightMagenta: '#d670d6',\n        brightCyan: '#29b8db',\n        brightWhite: '#ffffff',\n      },\n      allowProposedApi: true,\n    });\n\n    // Use CanvasAddon for recording compatibility\n    // NOTE: WebGL addon breaks canvas.captureStream() for MediaRecorder\n    // CanvasAddon provides canvas rendering that works with video recording\n    try {\n      const canvasAddon = new CanvasAddon.CanvasAddon();\n      term.loadAddon(canvasAddon);\n      console.log('Canvas addon loaded successfully');\n    } catch (e) {\n      console.warn('Canvas addon failed to load, using DOM renderer', e);\n    }\n\n    // Open terminal\n    term.open(document.getElementById('terminal'));\n    // DO NOT use fitAddon.fit() - we want fixed dimensions for recording\n\n    // Expose terminal to the page for interaction\n    window.term = term;\n\n    // Write initial prompt\n    term.write('$ ');\n\n    // Handle terminal input\n    term.onData(data => {\n      // Echo input back to terminal\n      term.write(data);\n\n      // Handle special keys\n      if (data.charCodeAt(0) === 13) { // Enter key\n        term.write('\\\\r\\\\n$ ');\n      } else if (data.charCodeAt(0) === 127) { // Backspace\n        term.write('\\\\b \\\\b');\n      }\n    });\n\n    // Expose functions for demo script interaction\n    window.writeToTerminal = (text) => {\n      term.write(text);\n    };\n\n    window.clearTerminal = () => {\n      term.clear();\n    };\n\n    console.log('Terminal initialized and ready for recording');\n  </script>\n</body>\n</html>\n  `.trim();\n}\n"],"names":["express","startServer","app","server","address","url","cleanup","get","_req","res","send","getTerminalHTML","Promise","resolve","reject","s","listen","on","port","close","err","trim"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAAA,OAAOA,aAA0B,UAAU;AAS3C,OAAO,SAAeC;;YACdC,KAQAC,QAKAC,SACAC,KAEAC;;;;oBAhBAJ,MAAeF;oBAErB,+BAA+B;oBAC/BE,IAAIK,GAAG,CAAC,KAAK,SAACC,MAAMC;wBAClBA,IAAIC,IAAI,CAACC;oBACX;oBAGuB;;wBAAM,IAAIC,QAAQ,SAACC,SAASC;4BACjD,IAAMC,IAAIb,IAAIc,MAAM,CAAC,GAAG;uCAAMH,QAAQE;;4BACtCA,EAAEE,EAAE,CAAC,SAASH;wBAChB;;;oBAHMX,SAAiB;oBAKjBC,UAAUD,OAAOC,OAAO;oBACxBC,MAAM,AAAC,oBAAgC,OAAbD,QAAQc,IAAI;oBAEtCZ,UAAU;;;;;wCACd;;4CAAM,IAAIM,QAAc,SAACC,SAASC;gDAChCX,OAAOgB,KAAK,CAACC,SAAAA;oDACX,IAAIA,KAAKN,OAAOM;yDACXP;gDACP;4CACF;;;wCALA;;;;;;wBAMF;;oBAEA;;wBAAO;4BAAER,KAAAA;4BAAKC,SAAAA;wBAAQ;;;;IACxB;;AAEA,SAASK;IACP,OAAO,w/GAgILU,IAAI;AACR","file":"server.js"}