{"version":3,"sources":["/Users/rquast/projects/fspec.videos/src/__tests__/recording-workflow-integration.test.ts"],"sourcesContent":["/**\n * Feature: spec/features/add-comprehensive-integration-tests-for-recording-workflow.feature\n *\n * Integration tests for complete recording workflow\n */\n\nimport { describe, it, expect, beforeEach, afterEach, vi } from 'vitest';\nimport { mkdirSync, writeFileSync, rmSync, existsSync } from 'fs';\nimport { join } from 'path';\n\n// Mock the recorder module before any imports\nvi.mock('../recorder.js', () => ({\n  startRecording: vi.fn().mockResolvedValue(undefined),\n}));\n\nimport { startRecording } from '../recorder.js';\nimport { recordAction } from '../index.js';\ndescribe('Feature: Recording workflow integration', () => {\n  const testDir = join(process.cwd(), '.test-integration');\n  const configPath = join(testDir, 'fspec-videos.config.json');\n  const scriptPath = join(process.cwd(), 'src', 'demos', 'basic-usage.ts');\n\n  beforeEach(() => {\n    if (!existsSync(testDir)) {\n      mkdirSync(testDir, { recursive: true });\n    }\n    vi.clearAllMocks();\n  });\n\n  afterEach(() => {\n    if (existsSync(testDir)) {\n      rmSync(testDir, { recursive: true, force: true });\n    }\n  });\n\n  describe('Scenario: Integration test with valid config file', () => {\n    it('should pass merged config options to recorder', async () => {\n      // @step Given I have a config file with width 100 and height 40\n      const config = {\n        width: 100,\n        height: 40,\n      };\n      writeFileSync(configPath, JSON.stringify(config, null, 2));\n\n      // @step When I run the record command\n      const options = {\n        script: scriptPath,\n        output: join(testDir, 'output.webm'),\n        headless: true,\n      };\n      await recordAction(options, testDir);\n\n      // @step Then the recorder module should be called with width 100 and height 40\n      expect(startRecording).toHaveBeenCalledWith(\n        expect.objectContaining({\n          width: 100,\n          height: 40,\n        })\n      );\n    });\n  });\n\n  describe('Scenario: Integration test with CLI override', () => {\n    it('should prioritize CLI options over config file', async () => {\n      // @step Given I have a config file with width 100\n      const config = {\n        width: 100,\n      };\n      writeFileSync(configPath, JSON.stringify(config, null, 2));\n\n      // @step When I run the record command with --width 120\n      const options = {\n        script: scriptPath,\n        output: join(testDir, 'output.webm'),\n        width: '120',\n        headless: true,\n      };\n      await recordAction(options, testDir);\n\n      // @step Then the recorder module should be called with width 120 from CLI\n      expect(startRecording).toHaveBeenCalledWith(\n        expect.objectContaining({\n          width: 120,\n        })\n      );\n\n      // @step And the config file width should be ignored\n      // (Verified by the width being 120, not 100)\n    });\n  });\n\n  describe('Scenario: Integration test with invalid config value', () => {\n    it('should fail validation before calling recorder', async () => {\n      // @step Given I have a config file with width 500\n      const config = {\n        width: 500,\n      };\n      writeFileSync(configPath, JSON.stringify(config, null, 2));\n\n      // @step When I run the record command\n      const options = {\n        script: scriptPath,\n        output: join(testDir, 'output.webm'),\n        headless: true,\n      };\n\n      // @step Then validation should fail before recorder is called\n      await expect(recordAction(options, testDir)).rejects.toThrow();\n      expect(startRecording).not.toHaveBeenCalled();\n\n      // @step And an error message should indicate width exceeds maximum\n      await expect(recordAction(options, testDir)).rejects.toThrow(\n        /Width must be between 1 and 300/\n      );\n    });\n  });\n\n  describe('Scenario: Integration test without config file', () => {\n    it('should use default values when no config exists', async () => {\n      // @step Given no config file exists in the project root\n      // (No config file created in this test)\n\n      // @step When I run the record command without options\n      const options = {\n        script: scriptPath,\n        output: join(testDir, 'output.webm'),\n        headless: true,\n      };\n      await recordAction(options, testDir);\n\n      // @step Then the recorder module should be called with default values\n      // @step And width should be 120\n      // @step And height should be 30\n      // @step And fps should be 30\n      expect(startRecording).toHaveBeenCalledWith(\n        expect.objectContaining({\n          width: 120,\n          height: 30,\n          fps: 30,\n        })\n      );\n    });\n  });\n\n  describe('Scenario: Integration test with invalid JSON in config', () => {\n    it('should show parse error with config file path', async () => {\n      // @step Given I have a config file with invalid JSON syntax\n      writeFileSync(configPath, '{ invalid json }');\n\n      // @step When I run the record command\n      const options = {\n        script: scriptPath,\n        output: join(testDir, 'output.webm'),\n        headless: true,\n      };\n\n      // @step Then a parse error should be shown\n      await expect(recordAction(options, testDir)).rejects.toThrow();\n\n      // @step And the error message should include the config file path\n      await expect(recordAction(options, testDir)).rejects.toThrow(\n        /fspec-videos\\.config\\.json/\n      );\n    });\n  });\n});\n"],"names":["describe","it","expect","beforeEach","afterEach","vi","mkdirSync","writeFileSync","rmSync","existsSync","join","mock","startRecording","fn","mockResolvedValue","undefined","recordAction","testDir","process","cwd","configPath","scriptPath","recursive","clearAllMocks","force","config","options","width","height","JSON","stringify","script","output","headless","toHaveBeenCalledWith","objectContaining","rejects","toThrow","not","toHaveBeenCalled","fps"],"mappings":"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","file":"recording-workflow-integration.test.js"}