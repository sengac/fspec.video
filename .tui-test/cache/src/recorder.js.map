{"version":3,"sources":["/Users/rquast/projects/fspec.videos/src/recorder.ts"],"sourcesContent":["import puppeteer, { Browser, Page } from 'puppeteer';\nimport { spawn } from 'child_process';\nimport { writeFile, mkdir } from 'fs/promises';\nimport { dirname } from 'path';\nimport { startServer } from './server.js';\n\nexport interface RecordingOptions {\n  scriptPath: string;\n  outputPath: string;\n  width: number;\n  height: number;\n  fps: number;\n  headless: boolean;\n}\n\nexport async function startRecording(options: RecordingOptions): Promise<void> {\n  let browser: Browser | null = null;\n  let serverCleanup: (() => Promise<void>) | null = null;\n\n  try {\n    // Ensure output directory exists\n    await mkdir(dirname(options.outputPath), { recursive: true });\n\n    // Start the Express server\n    console.log('Starting web server...');\n    const { url, cleanup } = await startServer();\n    serverCleanup = cleanup;\n\n    // Launch Puppeteer browser\n    console.log('Launching browser...');\n    browser = await puppeteer.launch({\n      headless: options.headless,\n      args: [\n        '--no-sandbox',\n        '--disable-setuid-sandbox',\n        '--disable-dev-shm-usage',\n        '--disable-web-security',\n        '--allow-file-access-from-files',\n      ],\n      defaultViewport: {\n        width: options.width * 10, // Approximate pixel width\n        height: options.height * 20, // Approximate pixel height\n      },\n    });\n\n    const page = await browser.newPage();\n\n    // Navigate to the terminal page\n    console.log('Loading terminal interface...');\n    await page.goto(url, { waitUntil: 'networkidle0' });\n\n    // Wait for terminal to be ready\n    await page.waitForSelector('#terminal', { timeout: 10000 });\n\n    // Start recording\n    console.log('Starting video capture...');\n    const recordingData = await startBrowserRecording(page, options);\n\n    // Run the demo script\n    console.log('Executing demo script...');\n    await runDemoScript(page, options.scriptPath);\n\n    // Stop recording\n    console.log('Stopping video capture...');\n    const videoBuffer = await stopBrowserRecording(page, recordingData);\n\n    // Save the video\n    console.log('Saving video...');\n    await writeFile(options.outputPath, videoBuffer);\n  } finally {\n    if (browser) {\n      await browser.close();\n    }\n    if (serverCleanup) {\n      await serverCleanup();\n    }\n  }\n}\n\nasync function startBrowserRecording(\n  page: Page,\n  options: RecordingOptions\n): Promise<{ recordingId: string }> {\n  // Inject recording script into the page\n  const recordingId = await page.evaluate((fps: number) => {\n    /* eslint-disable no-undef */\n    return new Promise<string>((resolve, reject) => {\n      const canvas = document.querySelector('canvas');\n      if (!canvas) {\n        reject(new Error('Canvas element not found'));\n        return;\n      }\n\n      // @ts-expect-error - captureStream is available on canvas\n      const stream = canvas.captureStream(fps);\n      const mediaRecorder = new MediaRecorder(stream, {\n        mimeType: 'video/webm;codecs=vp9',\n        videoBitsPerSecond: 2500000,\n      });\n\n      const chunks: Blob[] = [];\n      mediaRecorder.ondataavailable = (event: BlobEvent) => {\n        if (event.data.size > 0) {\n          chunks.push(event.data);\n        }\n      };\n\n      // Store in window for later access\n      // @ts-expect-error - custom property\n      window.__recordingData = { mediaRecorder, chunks };\n\n      mediaRecorder.start();\n      resolve('recording-started');\n    });\n    /* eslint-enable no-undef */\n  }, options.fps);\n\n  return { recordingId };\n}\n\nasync function stopBrowserRecording(\n  page: Page,\n  _recordingData: { recordingId: string }\n): Promise<Buffer> {\n  // Stop recording and get the video data\n  const base64Video = await page.evaluate(() => {\n    /* eslint-disable no-undef */\n    return new Promise<string>((resolve, reject) => {\n      // @ts-expect-error - custom property\n      const { mediaRecorder, chunks } = window.__recordingData;\n\n      if (!mediaRecorder) {\n        reject(new Error('No active recording found'));\n        return;\n      }\n\n      mediaRecorder.onstop = () => {\n        const blob = new Blob(chunks, { type: 'video/webm' });\n        const reader = new FileReader();\n        reader.onloadend = () => {\n          const base64 = (reader.result as string).split(',')[1];\n          resolve(base64);\n        };\n        reader.onerror = reject;\n        reader.readAsDataURL(blob);\n      };\n\n      mediaRecorder.stop();\n    });\n    /* eslint-enable no-undef */\n  });\n\n  return Buffer.from(base64Video, 'base64');\n}\n\nasync function runDemoScript(page: Page, scriptPath: string): Promise<void> {\n  // Execute the demo script using @microsoft/tui-test\n  // The script will interact with the terminal through the page\n  await page.evaluate((script: string) => {\n    console.log('Running demo script:', script);\n    // The actual script execution will be handled by the imported script\n  }, scriptPath);\n\n  // For now, spawn the demo script as a separate process\n  // and let it communicate with the page through the exposed functions\n  return new Promise((resolve, reject) => {\n    const child = spawn('node', ['--loader', 'tsx', scriptPath], {\n      env: {\n        ...process.env,\n        FSPEC_DEMO_MODE: 'true',\n      },\n    });\n\n    child.on('close', code => {\n      if (code === 0) {\n        resolve();\n      } else {\n        reject(new Error(`Demo script exited with code ${code}`));\n      }\n    });\n\n    child.on('error', reject);\n  });\n}\n"],"names":["puppeteer","spawn","writeFile","mkdir","dirname","startServer","startRecording","options","browser","serverCleanup","url","cleanup","page","recordingData","videoBuffer","outputPath","recursive","console","log","launch","headless","args","defaultViewport","width","height","newPage","goto","waitUntil","waitForSelector","timeout","startBrowserRecording","runDemoScript","scriptPath","stopBrowserRecording","close","recordingId","evaluate","fps","Promise","resolve","reject","canvas","document","querySelector","Error","stream","captureStream","mediaRecorder","MediaRecorder","mimeType","videoBitsPerSecond","chunks","ondataavailable","event","data","size","push","window","__recordingData","start","_recordingData","base64Video","onstop","blob","Blob","type","reader","FileReader","onloadend","base64","result","split","onerror","readAsDataURL","stop","Buffer","from","script","child","env","process","FSPEC_DEMO_MODE","on","code"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAAA,OAAOA,eAAkC,YAAY;AACrD,SAASC,KAAK,QAAQ,gBAAgB;AACtC,SAASC,SAAS,EAAEC,KAAK,QAAQ,cAAc;AAC/C,SAASC,OAAO,QAAQ,OAAO;AAC/B,SAASC,WAAW,QAAQ,cAAc;AAW1C,OAAO,SAAeC,eAAeC,OAAyB;;YACxDC,SACAC,eAQuB,MAAjBC,KAAKC,SAoBPC,MAWAC,eAQAC;;;;oBAhDJN,UAA0B;oBAC1BC,gBAA8C;;;;;;;;;oBAGhD,iCAAiC;oBACjC;;wBAAMN,MAAMC,QAAQG,QAAQQ,UAAU,GAAG;4BAAEC,WAAW;wBAAK;;;oBAA3D;oBAEA,2BAA2B;oBAC3BC,QAAQC,GAAG,CAAC;oBACa;;wBAAMb;;;oBAAN,OAAA,eAAjBK,MAAiB,KAAjBA,KAAKC,UAAY,KAAZA;oBACbF,gBAAgBE;oBAEhB,2BAA2B;oBAC3BM,QAAQC,GAAG,CAAC;oBACF;;wBAAMlB,UAAUmB,MAAM,CAAC;4BAC/BC,UAAUb,QAAQa,QAAQ;4BAC1BC,IAAI;gCACF;gCACA;gCACA;gCACA;gCACA;;4BAEFC,iBAAiB;gCACfC,OAAOhB,QAAQgB,KAAK,GAAG;gCACvBC,QAAQjB,QAAQiB,MAAM,GAAG;4BAC3B;wBACF;;;oBAbAhB,UAAU;oBAeG;;wBAAMA,QAAQiB,OAAO;;;oBAA5Bb,OAAO;oBAEb,gCAAgC;oBAChCK,QAAQC,GAAG,CAAC;oBACZ;;wBAAMN,KAAKc,IAAI,CAAChB,KAAK;4BAAEiB,WAAW;wBAAe;;;oBAAjD;oBAEA,gCAAgC;oBAChC;;wBAAMf,KAAKgB,eAAe,CAAC,aAAa;4BAAEC,SAAS;wBAAM;;;oBAAzD;oBAEA,kBAAkB;oBAClBZ,QAAQC,GAAG,CAAC;oBACU;;wBAAMY,sBAAsBlB,MAAML;;;oBAAlDM,gBAAgB;oBAEtB,sBAAsB;oBACtBI,QAAQC,GAAG,CAAC;oBACZ;;wBAAMa,cAAcnB,MAAML,QAAQyB,UAAU;;;oBAA5C;oBAEA,iBAAiB;oBACjBf,QAAQC,GAAG,CAAC;oBACQ;;wBAAMe,qBAAqBrB,MAAMC;;;oBAA/CC,cAAc;oBAEpB,iBAAiB;oBACjBG,QAAQC,GAAG,CAAC;oBACZ;;wBAAMhB,UAAUK,QAAQQ,UAAU,EAAED;;;oBAApC;;;;;;yBAEIN,SAAAA;;;;oBACF;;wBAAMA,QAAQ0B,KAAK;;;oBAAnB;;;yBAEEzB,eAAAA;;;;oBACF;;wBAAMA;;;oBAAN;;;;;;;;;;;;IAGN;;AAEA,SAAeqB,sBACblB,IAAU,EACVL,OAAyB;;YAGnB4B;;;;oBAAc;;wBAAMvB,KAAKwB,QAAQ,CAAC,SAACC;4BACvC,2BAA2B,GAC3B,OAAO,IAAIC,QAAgB,SAACC,SAASC;gCACnC,IAAMC,SAASC,SAASC,aAAa,CAAC;gCACtC,IAAI,CAACF,QAAQ;oCACXD,OAAO,IAAII,MAAM;oCACjB;gCACF;gCAEA,0DAA0D;gCAC1D,IAAMC,SAASJ,OAAOK,aAAa,CAACT;gCACpC,IAAMU,gBAAgB,IAAIC,cAAcH,QAAQ;oCAC9CI,UAAU;oCACVC,oBAAoB;gCACtB;gCAEA,IAAMC,SAAiB,EAAE;gCACzBJ,cAAcK,eAAe,GAAG,SAACC;oCAC/B,IAAIA,MAAMC,IAAI,CAACC,IAAI,GAAG,GAAG;wCACvBJ,OAAOK,IAAI,CAACH,MAAMC,IAAI;oCACxB;gCACF;gCAEA,mCAAmC;gCACnC,qCAAqC;gCACrCG,OAAOC,eAAe,GAAG;oCAAEX,eAAAA;oCAAeI,QAAAA;gCAAO;gCAEjDJ,cAAcY,KAAK;gCACnBpB,QAAQ;4BACV;wBACA,0BAA0B,GAC5B,GAAGhC,QAAQ8B,GAAG;;;oBA/BRF,cAAc;oBAiCpB;;wBAAO;4BAAEA,aAAAA;wBAAY;;;;IACvB;;AAEA,SAAeF,qBACbrB,IAAU,EACVgD,cAAuC;;YAGjCC;;;;oBAAc;;wBAAMjD,KAAKwB,QAAQ,CAAC;4BACtC,2BAA2B,GAC3B,OAAO,IAAIE,QAAgB,SAACC,SAASC;gCACnC,qCAAqC;gCACrC,IAAkCiB,0BAAAA,OAAOC,eAAe,EAAhDX,gBAA0BU,wBAA1BV,eAAeI,SAAWM,wBAAXN;gCAEvB,IAAI,CAACJ,eAAe;oCAClBP,OAAO,IAAII,MAAM;oCACjB;gCACF;gCAEAG,cAAce,MAAM,GAAG;oCACrB,IAAMC,OAAO,IAAIC,KAAKb,QAAQ;wCAAEc,MAAM;oCAAa;oCACnD,IAAMC,SAAS,IAAIC;oCACnBD,OAAOE,SAAS,GAAG;wCACjB,IAAMC,SAAS,AAACH,OAAOI,MAAM,CAAYC,KAAK,CAAC,IAAI,CAAC,EAAE;wCACtDhC,QAAQ8B;oCACV;oCACAH,OAAOM,OAAO,GAAGhC;oCACjB0B,OAAOO,aAAa,CAACV;gCACvB;gCAEAhB,cAAc2B,IAAI;4BACpB;wBACA,0BAA0B,GAC5B;;;oBAzBMb,cAAc;oBA2BpB;;wBAAOc,OAAOC,IAAI,CAACf,aAAa;;;;IAClC;;AAEA,SAAe9B,cAAcnB,IAAU,EAAEoB,UAAkB;;;;;oBACzD,oDAAoD;oBACpD,8DAA8D;oBAC9D;;wBAAMpB,KAAKwB,QAAQ,CAAC,SAACyC;4BACnB5D,QAAQC,GAAG,CAAC,wBAAwB2D;wBACpC,qEAAqE;wBACvE,GAAG7C;;;oBAHH;oBAKA,uDAAuD;oBACvD,qEAAqE;oBACrE;;wBAAO,IAAIM,QAAQ,SAACC,SAASC;4BAC3B,IAAMsC,QAAQ7E,MAAM,QAAQ;gCAAC;gCAAY;gCAAO+B;6BAAW,EAAE;gCAC3D+C,KAAK,wCACAC,QAAQD,GAAG;oCACdE,iBAAiB;;4BAErB;4BAEAH,MAAMI,EAAE,CAAC,SAASC,SAAAA;gCAChB,IAAIA,SAAS,GAAG;oCACd5C;gCACF,OAAO;oCACLC,OAAO,IAAII,MAAM,AAAC,gCAAoC,OAALuC;gCACnD;4BACF;4BAEAL,MAAMI,EAAE,CAAC,SAAS1C;wBACpB;;;;IACF","file":"recorder.js"}