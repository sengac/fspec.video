{"version":3,"sources":["/Users/rquast/projects/fspec.videos/src/recorder.ts"],"sourcesContent":["import puppeteer, { Browser, Page } from 'puppeteer';\nimport { spawn } from 'child_process';\nimport { writeFile, mkdir } from 'fs/promises';\nimport { dirname } from 'path';\nimport { startServer } from './server.js';\n\nexport interface RecordingOptions {\n  scriptPath: string;\n  outputPath: string;\n  width: number;\n  height: number;\n  fps: number;\n  headless: boolean;\n}\n\nexport async function startRecording(options: RecordingOptions): Promise<void> {\n  let browser: Browser | null = null;\n  let serverCleanup: (() => Promise<void>) | null = null;\n\n  try {\n    // Ensure output directory exists\n    await mkdir(dirname(options.outputPath), { recursive: true });\n\n    // Start the Express server\n    console.log('Starting web server...');\n    const { url, cleanup } = await startServer();\n    serverCleanup = cleanup;\n\n    // Launch Puppeteer browser\n    console.log('Launching browser...');\n    browser = await puppeteer.launch({\n      headless: options.headless,\n      args: [\n        '--no-sandbox',\n        '--disable-setuid-sandbox',\n        '--disable-dev-shm-usage',\n        '--disable-web-security',\n        '--allow-file-access-from-files',\n      ],\n      defaultViewport: {\n        // 4K resolution for high quality recording\n        width: 3840,\n        height: 2160,\n      },\n    });\n\n    const page = await browser.newPage();\n\n    // Listen to browser console for debugging\n    page.on('console', msg => {\n      const type = msg.type();\n      const text = msg.text();\n      if (type === 'error') {\n        console.error(`ðŸŒ Browser console.error: ${text}`);\n      } else {\n        console.log(`ðŸŒ Browser console.${type}: ${text}`);\n      }\n    });\n\n    // Navigate to the terminal page\n    console.log('Loading terminal interface...');\n    await page.goto(url, { waitUntil: 'networkidle0' });\n\n    // Wait for terminal to be ready\n    await page.waitForSelector('#terminal', { timeout: 10000 });\n\n    // Wait for canvas element to be created by xterm.js\n    await page.waitForSelector('canvas', { timeout: 10000 });\n\n    // Wait a bit more to ensure xterm has done its initial render\n    await new Promise(resolve => setTimeout(resolve, 500));\n\n    // Start recording using Puppeteer's built-in screencast\n    console.log('Starting video capture...');\n    const recorder = await page.screencast({ path: options.outputPath, ffmpegPath: 'ffmpeg' });\n\n    // Run the demo script\n    console.log('Executing demo script...');\n    await runDemoScript(page, options.scriptPath);\n\n    // Wait a bit to ensure last frames are captured\n    await new Promise(resolve => setTimeout(resolve, 500));\n\n    // Stop recording\n    console.log('Stopping video capture...');\n    await recorder.stop();\n  } finally {\n    if (browser) {\n      await browser.close();\n    }\n    if (serverCleanup) {\n      await serverCleanup();\n    }\n  }\n}\n\nasync function runDemoScript(page: Page, scriptPath: string): Promise<void> {\n  // Spawn the demo script as a separate process\n  // Capture stdout and send to browser terminal via window.writeToTerminal()\n  return new Promise((resolve, reject) => {\n    const child = spawn('npx', ['tsx', scriptPath], {\n      env: {\n        ...process.env,\n        FSPEC_DEMO_MODE: 'true',\n      },\n    });\n\n    // Capture stdout and send each chunk to browser terminal\n    child.stdout.on('data', async (data: Buffer) => {\n      const text = data.toString();\n      console.log('ðŸ“ Captured stdout:', JSON.stringify(text));\n\n      try {\n        await page.evaluate((t: string) => {\n          console.log('ðŸŒ Browser received:', JSON.stringify(t));\n          // @ts-expect-error - window.writeToTerminal is exposed by server.ts\n          if (typeof window.writeToTerminal === 'function') {\n            // @ts-expect-error - window.writeToTerminal is exposed by server.ts\n            window.writeToTerminal(t);\n            console.log('âœ… Written to terminal');\n          } else {\n            console.error('âŒ window.writeToTerminal is not a function:', typeof window.writeToTerminal);\n          }\n        }, text);\n      } catch (error) {\n        console.error('âŒ Error sending to browser:', error);\n      }\n    });\n\n    // Also capture stderr for debugging\n    child.stderr.on('data', async (data: Buffer) => {\n      const text = data.toString();\n      console.error('Demo script stderr:', text);\n    });\n\n    child.on('close', code => {\n      if (code === 0) {\n        resolve();\n      } else {\n        reject(new Error(`Demo script exited with code ${code}`));\n      }\n    });\n\n    child.on('error', reject);\n  });\n}\n"],"names":["puppeteer","spawn","mkdir","dirname","startServer","startRecording","options","browser","serverCleanup","url","cleanup","page","recorder","outputPath","recursive","console","log","launch","headless","args","defaultViewport","width","height","newPage","on","msg","type","text","error","goto","waitUntil","waitForSelector","timeout","Promise","resolve","setTimeout","screencast","path","ffmpegPath","runDemoScript","scriptPath","stop","close","reject","child","env","process","FSPEC_DEMO_MODE","stdout","data","toString","JSON","stringify","evaluate","t","window","writeToTerminal","stderr","code","Error"],"mappings":"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","file":"recorder.js"}